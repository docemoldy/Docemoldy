<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doce Moldy | Loja Oficial</title>
    <link rel="icon" type="image/png" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #8B5CF6; --primary-dark: #7C3AED;
            --accent: #FDE68A; --bg-body: #F3F4F6;
            --white: #FFFFFF; --text-dark: #1F2937;
            --text-gray: #6B7280; --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --success: #10B981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-body); color: var(--text-dark); padding-top: 100px; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        ul { list-style: none; }
        img { max-width: 100%; display: block; }
        button { cursor: pointer; border: none; font-family: inherit; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* HEADER */
        .header-fixed { position: fixed; top: 0; left: 0; width: 100%; background: var(--white); z-index: 1000; box-shadow: var(--shadow); }
        .top-bar { background: var(--text-dark); color: white; text-align: center; font-size: 0.8rem; padding: 6px 0; font-weight: 700; }
        .nav-bar { padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .logo img { height: 40px; }
        
        .menu-icons { display: flex; gap: 20px; color: var(--text-gray); align-items: flex-start; }
        
        /* √ÅREA DO CARRINHO */
        .cart-wrapper { position: relative; cursor: pointer; padding-bottom: 10px; }
        .cart-link { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; font-weight: 600; position: relative; }
        .cart-link i { font-size: 1.4rem; margin-bottom: 2px; color: var(--text-dark); }
        .cart-link:hover i { color: var(--primary); }

        .cart-dropdown {
            position: absolute; top: 100%; right: 0; width: 300px;
            background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 15px; z-index: 1100;
            opacity: 0; visibility: hidden; transform: translateY(10px);
            transition: all 0.3s ease; border: 1px solid #f3f4f6;
        }
        .cart-wrapper:hover .cart-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
        .cart-dropdown::before {
            content: ''; position: absolute; top: -6px; right: 20px;
            width: 12px; height: 12px; background: white;
            transform: rotate(45deg); border-left: 1px solid #f3f4f6; border-top: 1px solid #f3f4f6;
        }

        .mini-item { display: flex; gap: 10px; margin-bottom: 12px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .mini-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }
        .mini-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .mini-name { font-size: 0.85rem; font-weight: 700; line-height: 1.2; color: #333; margin-bottom: 2px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .mini-price { font-size: 0.85rem; color: var(--primary); font-weight: 800; }
        
        .mini-footer { text-align: center; margin-top: 10px; }
        .mini-total { display: flex; justify-content: space-between; font-weight: 800; margin-bottom: 10px; color: #333; }
        .btn-mini-cart { display: block; width: 100%; background: #25D366; color: white; padding: 10px; border-radius: 8px; font-weight: 700; text-decoration: none; font-size: 0.9rem; }
        .btn-mini-cart:hover { background: #1ebc57; }

        .cart-count {
            position: absolute; top: -5px; right: 5px;
            background: #EF4444; color: white;
            font-size: 0.7rem; font-weight: 800;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s;
        }
        .cart-count.visible { opacity: 1; }

        /* TOAST NOTIFICATION (NOVO) */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: white; color: #333; padding: 15px 20px;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px;
            border-left: 5px solid var(--success);
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            min-width: 300px;
        }
        .toast i { color: var(--success); font-size: 1.2rem; }
        .toast-content { display: flex; flex-direction: column; }
        .toast-title { font-weight: 800; font-size: 0.95rem; }
        .toast-msg { font-size: 0.85rem; color: #666; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateY(-20px); opacity: 0; } }

        /* HERO & GERAL */
        .hero { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 40px 0; margin-bottom: 40px; border-radius: 0 0 30px 30px; text-align: center; }
        .hero h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .hero p { opacity: 0.9; margin-bottom: 20px; font-size: 1.1rem; }
        .btn-hero { background: var(--accent); color: var(--text-dark); padding: 10px 30px; border-radius: 50px; font-weight: 800; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .cat-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 40px; justify-content: center; }
        .cat-pill { background: var(--white); padding: 10px 20px; border-radius: 50px; font-weight: 700; color: var(--text-gray); box-shadow: var(--shadow); white-space: nowrap; border: 2px solid transparent; display: flex; align-items: center; gap: 8px; }
        .cat-pill:hover { border-color: var(--primary); color: var(--primary); }
        .cat-pill i { color: var(--primary); }

        .section-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-dark); }
        .section-title::before { content: ''; width: 6px; height: 25px; background: var(--primary); border-radius: 4px; }
        .products-grid { display: flex; gap: 20px; overflow-x: auto; padding: 10px 5px 30px 5px; min-height: 350px; }
        
        .product-card { background: var(--white); min-width: 240px; max-width: 240px; border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); position: relative; transition: 0.3s; border: 1px solid transparent; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .badge-offer { position: absolute; top: 15px; left: 15px; background: var(--accent); color: var(--text-dark); font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; z-index: 2;}
        .p-img-box { height: 200px; width: 100%; border-radius: 10px; background: #f9fafb; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative;}
        .p-img-box img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        .p-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-price { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .p-old { font-size: 0.85rem; text-decoration: line-through; color: #9CA3AF; margin-right: 5px; }
        .btn-add { width: 100%; background: var(--primary); color: white; padding: 10px; border-radius: 10px; font-weight: 700; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; position: relative; overflow: hidden; cursor: pointer; }
        .btn-add:hover { background: var(--primary-dark); }

        footer { background: var(--white); padding: 40px 0; margin-top: 50px; color: var(--text-gray); text-align: center; }
        .float-whats { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #25D366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 999; }
        
        .login-link { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; font-weight: 600; text-decoration: none; color: var(--text-gray); }
        .login-link i { font-size: 1.4rem; margin-bottom: 2px; color: var(--text-dark); }
        .login-link:hover i { color: var(--primary); }

        @media(max-width: 768px) { 
            .cat-scroll { justify-content: flex-start; } 
            .hero { border-radius: 0 0 20px 20px; padding: 30px 15px; } 
            .cart-dropdown { display: none; }
        }

        .fly-img { position: fixed; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; object-fit: cover; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- Container das Notifica√ß√µes -->
    <div id="toast-container"></div>

    <!-- Barra de Troca (S√≥ aparece se estiver trocando) -->
    <div id="troca-bar" style="display: none; background: #F59E0B; color: white; text-align: center; padding: 10px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1100;">
        üîÑ Voc√™ est√° trocando um produto. Escolha o novo abaixo ou <a href="#" onclick="cancelarTroca()" style="color:white; text-decoration:underline;">Cancelar</a>.
    </div>

    <header class="header-fixed">
        <div class="top-bar">FRETE GR√ÅTIS ACIMA DE R$ 299,00 üöö</div>
        <div class="container nav-bar">
            <a href="index.html" class="logo">
                <img src="logo_site.png" onerror="this.style.display='none'">
                <span>DoceMoldy</span>
            </a>
            
            <div class="menu-icons">
                <div class="cart-wrapper" onclick="window.location.href='carrinho.html'">
                    <div class="cart-link" id="cart-icon-container">
                        <i class="fa-solid fa-cart-shopping" id="cart-icon"></i>
                        <span id="cart-count" class="cart-count">0</span>
                        Carrinho
                    </div>
                    <div class="cart-dropdown" id="mini-cart-content">
                        <p style="text-align:center; color:#999; font-size:0.9rem;">Seu carrinho est√° vazio.</p>
                    </div>
                </div>

                <a href="conta.html" class="login-link" id="user-link">
                    <i class="fa-regular fa-user"></i>
                    <span id="user-label">Login</span>
                </a>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>Sua Confeitaria Profissional ‚ú®</h1>
            <p>Os melhores cortadores e carimbos do mercado.</p>
            <a href="#sec-carimbos" class="btn-hero">Ver Cat√°logo</a>
        </div>
    </section>

    <div class="container" id="vitrine">
        <div class="cat-scroll">
            <a href="#sec-carimbos" class="cat-pill"><i class="fa-solid fa-cookie"></i> Carimbos Biscoito</a>
            <a href="#sec-doces" class="cat-pill"><i class="fa-solid fa-candy-cane"></i> Carimbinho Doces</a>
            <a href="#sec-modeladores" class="cat-pill"><i class="fa-solid fa-shapes"></i> Modeladores</a>
            <a href="#sec-outros" class="cat-pill"><i class="fa-solid fa-star"></i> Outros</a>
        </div>

        <div class="section-title">üç™ Carimbos de Biscoito</div>
        <div class="products-grid" id="sec-carimbos"><p>Carregando...</p></div>

        <div class="section-title">üç¨ Carimbinho de Doces</div>
        <div class="products-grid" id="sec-doces"><p>Carregando...</p></div>

        <div class="section-title">‚ú® Modeladores</div>
        <div class="products-grid" id="sec-modeladores"><p>Carregando...</p></div>

        <div class="section-title">‚≠ê Outros</div>
        <div class="products-grid" id="sec-outros"><p>Carregando...</p></div>
    </div>

    <footer>
        <div class="container">
            <p style="margin-bottom: 10px;">&copy; 2024 Doce Moldy. Todos os direitos reservados.</p>
            <p style="font-size: 0.9rem;"><a href="admin.html" style="color:#ccc">Acesso Administrativo</a></p>
        </div>
    </footer>

    <a href="https://wa.me/5511999999999" class="float-whats" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>

    <!-- SCRIPT FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASxticHF-jnuOj2xcHm0Jc3P4U0ZOzF10",
            authDomain: "doce-moldy.firebaseapp.com",
            projectId: "doce-moldy",
            storageBucket: "doce-moldy.firebasestorage.app",
            messagingSenderId: "965940506290",
            appId: "1:965940506290:web:0067cfc07ad49399eb23ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let carrinho = JSON.parse(localStorage.getItem('carrinho_doce_moldy')) || [];
        
        // VERIFICA MODO TROCA
        const indiceTroca = localStorage.getItem('indice_troca');
        const isTrocaMode = indiceTroca !== null;

        if(isTrocaMode) {
            document.getElementById('troca-bar').style.display = 'block';
            document.body.style.paddingTop = '140px'; 
        }

        // --- SISTEMA DE NOTIFICA√á√ÉO (TOAST) ---
        window.showToast = (msg, title = 'Sucesso') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fa-solid fa-circle-check"></i>
                <div class="toast-content">
                    <span class="toast-title">${title}</span>
                    <span class="toast-msg">${msg}</span>
                </div>
            `;
            container.appendChild(toast);
            
            // Remove automaticamente ap√≥s 3.5s
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3500);
        }

        window.cancelarTroca = () => {
            localStorage.removeItem('indice_troca');
            window.location.reload();
        }

        window.realizarTroca = (nome, preco, imagem) => {
            const index = parseInt(localStorage.getItem('indice_troca'));
            if(!isNaN(index) && carrinho[index]) {
                carrinho[index] = { nome, preco, imagem };
                salvarDadosUsuario();
                localStorage.removeItem('indice_troca');
                
                // Toast + Redirecionamento
                window.showToast(`Trocado por "${nome}"!`, 'Atualizado');
                setTimeout(() => {
                    window.location.href = 'carrinho.html';
                }, 1500);
            }
        }

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-label').innerText = "Minha Conta";
                document.getElementById('user-link').href = "conta.html";
                
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.cart) carrinho = data.cart;
                    atualizarMiniCart();
                }
            } else {
                document.getElementById('user-label').innerText = "Login";
            }
        });

        async function salvarDadosUsuario() {
            localStorage.setItem('carrinho_doce_moldy', JSON.stringify(carrinho));
            if(currentUser) {
                await setDoc(doc(db, "users", currentUser.uid), { cart: carrinho, email: currentUser.email }, { merge: true });
            }
        }

        // --- CARRINHO ---
        window.atualizarMiniCart = () => {
            if(isTrocaMode) return; 
            const badge = document.getElementById('cart-count');
            const dropdown = document.getElementById('mini-cart-content');
            
            badge.innerText = carrinho.length;
            if(carrinho.length > 0) badge.classList.add('visible');
            else badge.classList.remove('visible');

            if(carrinho.length === 0) {
                dropdown.innerHTML = '<p style="text-align:center; padding:10px; color:#999">Carrinho vazio</p>';
                return;
            }

            let html = '';
            let total = 0;
            const preview = carrinho.slice().reverse().slice(0, 3);

            preview.forEach((item, idx) => {
                const realIndex = carrinho.length - 1 - idx;
                html += `
                    <div class="mini-item">
                        <img src="${item.imagem}" class="mini-img">
                        <div class="mini-info">
                            <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;">${item.nome}</div>
                            <div style="color:var(--primary)">${item.preco}</div>
                        </div>
                    </div>
                `;
            });

            let totalGeral = carrinho.reduce((acc, curr) => acc + (parseFloat(curr.preco.replace(/[^0-9,]/g, '').replace(',', '.')) || 0), 0);
            let totalFmt = totalGeral.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            html += `
                <div style="display:flex; justify-content:space-between; font-weight:800; margin:10px 0;">
                    <span>Total:</span><span>${totalFmt}</span>
                </div>
                <a href="carrinho.html" style="display:block; text-align:center; background:#10B981; color:white; padding:10px; border-radius:8px; font-weight:700; text-decoration:none;">Ver Carrinho</a>
            `;
            dropdown.innerHTML = html;
        };

        window.adicionarAoCarrinho = (btn, nome, preco, imagem) => {
            carrinho.push({ nome, preco, imagem });
            salvarDadosUsuario();
            atualizarMiniCart();
            
            // Anima√ß√£o Fly
            const card = btn.closest('.product-card');
            const imgEl = card.querySelector('.p-img-box img');
            const cartIcon = document.getElementById('cart-icon');

            if (imgEl && cartIcon) {
                const fly = imgEl.cloneNode();
                fly.classList.add('fly-img');
                const rect = imgEl.getBoundingClientRect();
                fly.style.top = rect.top + 'px'; fly.style.left = rect.left + 'px';
                fly.style.width = rect.width + 'px'; fly.style.height = rect.height + 'px';
                document.body.appendChild(fly);
                const end = cartIcon.getBoundingClientRect();
                
                setTimeout(() => {
                    fly.style.top = end.top + 'px'; fly.style.left = end.left + 'px';
                    fly.style.width = '20px'; fly.style.height = '20px'; fly.style.opacity = '0';
                }, 50);
                setTimeout(() => {
                    fly.remove();
                    // Mostra Toast ao terminar anima√ß√£o
                    window.showToast(`${nome} adicionado!`, 'Sucesso');
                }, 800);
            } else {
                window.showToast(`${nome} adicionado!`, 'Sucesso');
            }
        }

        // --- CARROSSEL ---
        function codificarCaminho(caminho) {
            if (!caminho) return '';
            return caminho.split('/').map(p => encodeURIComponent(p)).join('/');
        }

        async function carregar() {
            window.atualizarMiniCart();
            const q = query(collection(db, "produtos"), orderBy("date", "desc"));
            const sn = await getDocs(q);
            ['sec-carimbos', 'sec-doces', 'sec-modeladores', 'sec-outros'].forEach(id => document.getElementById(id).innerHTML="");
            
            if(sn.empty) return;

            sn.forEach(doc => {
                const i = doc.data();
                let target = 'sec-outros';
                if(i.category === 'Carimbos de Biscoito') target = 'sec-carimbos';
                else if(i.category === 'Carimbinhos doces') target = 'sec-doces';
                else if(i.category === 'modeladores') target = 'sec-modeladores';
                
                const container = document.getElementById(target);
                if(container) {
                    let imgs = Array.isArray(i.images) ? i.images : [i.img];
                    const fotosSeguras = imgs.map(url => {
                        let safe = url || '';
                        if(safe.startsWith('fotos/')) safe = safe.replace('fotos/', 'Fotos/');
                        return codificarCaminho(safe);
                    });
                    const imgCapa = fotosSeguras[0] || 'https://placehold.co/300';

                    let botaoHtml = '';
                    if (isTrocaMode) {
                        botaoHtml = `
                        <button class="btn-add" style="background:#F59E0B;" onclick="realizarTroca('${i.name}', '${i.price}', '${imgCapa}')">
                            <i class="fa-solid fa-rotate"></i> Substituir por este
                        </button>`;
                    } else {
                        botaoHtml = `
                        <button class="btn-add" onclick="adicionarAoCarrinho(this, '${i.name}', '${i.price}', '${imgCapa}')">
                            <i class="fa-solid fa-cart-plus"></i> Comprar
                        </button>`;
                    }

                    container.innerHTML += `
                    <div class="product-card" onmouseenter="iniciarSlide(this)" onmouseleave="pararSlide(this)" data-photos='${JSON.stringify(fotosSeguras)}'>
                        <a href="produto.html?id=${doc.id}" class="p-img-box">
                            <img src="${imgCapa}" class="slide-img" onerror="this.src='https://placehold.co/300'">
                        </a>
                        <div class="p-info">
                            <div class="p-title">${i.name}</div>
                            <div class="p-price">${i.price}</div>
                            ${botaoHtml}
                        </div>
                    </div>`;
                }
            });
        }

        window.intervals = {};
        window.iniciarSlide = (card) => {
            const fotos = JSON.parse(card.getAttribute('data-photos'));
            if(fotos.length <= 1) return;
            const imgEl = card.querySelector('.slide-img');
            let idx = 0;
            window.intervals[card] = setInterval(() => {
                idx = (idx + 1) % fotos.length;
                imgEl.style.opacity = '0.5';
                setTimeout(() => { imgEl.src = fotos[idx]; imgEl.style.opacity = '1'; }, 200);
            }, 3000);
        };
        window.pararSlide = (card) => {
            clearInterval(window.intervals[card]);
            const fotos = JSON.parse(card.getAttribute('data-photos'));
            const imgEl = card.querySelector('.slide-img');
            imgEl.src = fotos[0]; imgEl.style.opacity = '1';
        };

        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>
</html>