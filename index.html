<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doce Moldy | Loja Oficial</title>
    <link rel="icon" type="image/png" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #8B5CF6; --primary-dark: #7C3AED; --accent: #FDE68A; --bg-body: #F3F4F6; --white: #FFFFFF; --text-dark: #1F2937; --text-gray: #6B7280; --radius: 16px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-body); color: var(--text-dark); padding-top: 90px; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* HEADER */
        .header-fixed { position: fixed; top: 0; left: 0; width: 100%; background: var(--white); z-index: 1000; box-shadow: var(--shadow); height: 80px; display: flex; align-items: center; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo img { height: 55px; transition: 0.2s; } .logo:hover img { transform: scale(1.05); }
        
        .menu-icons { display: flex; gap: 25px; align-items: center; }
        .menu-btn { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; font-weight: 700; color: var(--text-gray); position: relative; cursor: pointer; }
        .menu-btn i { font-size: 1.5rem; margin-bottom: 2px; color: var(--text-dark); }
        .menu-btn:hover i { color: var(--primary); }

        /* MINI CARRINHO */
        .cart-wrapper { position: relative; }
        .cart-dropdown { position: absolute; top: 100%; right: 0; width: 320px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 15px; z-index: 1100; opacity: 0; visibility: hidden; transform: translateY(15px); transition: all 0.3s; border: 1px solid #f3f4f6; }
        .cart-wrapper:hover .cart-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
        
        .mini-item { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; position: relative; }
        .mini-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .mini-info { flex: 1; font-size: 0.9rem; }
        .mini-del { color: #EF4444; background: none; border:none; position: absolute; right: 0; top: 5px; cursor: pointer; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: #EF4444; color: white; font-size: 0.7rem; font-weight: 800; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; }
        .cart-count.visible { opacity: 1; }

        /* GERAL */
        .hero { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 40px 0; margin-bottom: 40px; border-radius: 0 0 30px 30px; text-align: center; }
        .hero h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .btn-hero { background: var(--accent); color: var(--text-dark); padding: 10px 30px; border-radius: 50px; font-weight: 800; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .cat-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 40px; justify-content: center; }
        .cat-pill { background: var(--white); padding: 10px 20px; border-radius: 50px; font-weight: 700; color: var(--text-gray); box-shadow: var(--shadow); white-space: nowrap; border: 2px solid transparent; display: flex; align-items: center; gap: 8px; }
        .cat-pill:hover { border-color: var(--primary); color: var(--primary); }
        .cat-pill i { color: var(--primary); }

        .section-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-dark); }
        .section-title::before { content: ''; width: 6px; height: 25px; background: var(--primary); border-radius: 4px; }
        .products-grid { display: flex; gap: 20px; overflow-x: auto; padding: 10px 5px 30px 5px; min-height: 350px; }
        
        .product-card { background: var(--white); min-width: 240px; max-width: 240px; border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); position: relative; transition: 0.3s; border: 1px solid transparent; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .badge-offer { position: absolute; top: 15px; left: 15px; background: var(--accent); color: var(--text-dark); font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; z-index: 2;}
        .p-img-box { height: 200px; width: 100%; border-radius: 10px; background: #f9fafb; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative;}
        .p-img-box img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        .p-title { font-weight: 700; font-size: 1rem; margin-bottom: 5px; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-price { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .p-old { font-size: 0.85rem; text-decoration: line-through; color: #9CA3AF; margin-right: 5px; }
        .btn-add { width: 100%; background: var(--primary); color: white; padding: 10px; border-radius: 10px; font-weight: 700; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; border:none; cursor: pointer; }
        .btn-add:hover { background: var(--primary-dark); }

        footer { background: var(--white); padding: 40px 0; margin-top: 50px; color: var(--text-gray); text-align: center; }
        .float-whats { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #25D366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 999; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 5px solid #10B981; z-index: 9999; animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .fly-img { position: fixed; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; object-fit: cover; pointer-events: none; transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="troca-bar" style="display: none; background: #F59E0B; color: white; text-align: center; padding: 10px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1100;">
        üîÑ Trocando produto. Escolha o novo ou <a href="#" onclick="cancelarTroca()" style="color:white; text-decoration:underline;">Cancelar</a>.
    </div>

    <header class="header-fixed">
        <div class="container nav-bar">
            <a href="index.html" class="logo">
                <img src="logo_site.png" onerror="this.style.display='none'; this.parentElement.innerHTML='DoceMoldy'">
            </a>
            
            <div class="menu-icons">
                <div class="cart-wrapper" onclick="window.location.href='carrinho.html'">
                    <div class="menu-btn" id="cart-icon-container">
                        <i class="fa-solid fa-cart-shopping" id="cart-icon"></i>
                        <span id="cart-count" class="cart-count">0</span>
                        Carrinho
                    </div>
                    <div class="cart-dropdown" id="mini-cart-content">
                        <p style="text-align:center; color:#999; font-size:0.9rem;">Vazio</p>
                    </div>
                </div>

                <a href="conta.html" class="menu-btn" id="user-link" style="text-align:center;">
                    <i class="fa-regular fa-user"></i>
                    <span id="user-label">Entrar /<br>Cadastrar</span>
                </a>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>Sua Confeitaria Profissional ‚ú®</h1>
            <p>Os melhores cortadores e carimbos do mercado.</p>
            <a href="#sec-carimbos" class="btn-hero">Ver Cat√°logo</a>
        </div>
    </section>

    <div class="container" id="vitrine">
        <div class="cat-scroll">
            <a href="#sec-carimbos" class="cat-pill"><i class="fa-solid fa-cookie"></i> Carimbos Biscoito</a>
            <a href="#sec-doces" class="cat-pill"><i class="fa-solid fa-candy-cane"></i> Carimbinho Doces</a>
            <a href="#sec-modeladores" class="cat-pill"><i class="fa-solid fa-shapes"></i> Modeladores</a>
            <a href="#sec-outros" class="cat-pill"><i class="fa-solid fa-star"></i> Outros</a>
        </div>

        <div class="section-title">üç™ Carimbos de Biscoito</div>
        <div class="products-grid" id="sec-carimbos"><p>Carregando...</p></div>

        <div class="section-title">üç¨ Carimbinho de Doces</div>
        <div class="products-grid" id="sec-doces"><p>Carregando...</p></div>

        <div class="section-title">‚ú® Modeladores</div>
        <div class="products-grid" id="sec-modeladores"><p>Carregando...</p></div>

        <div class="section-title">‚≠ê Outros</div>
        <div class="products-grid" id="sec-outros"><p>Carregando...</p></div>
    </div>

    <footer>
        <div class="container"><p>&copy; 2024 Doce Moldy</p><a href="admin.html">Admin</a></div>
    </footer>
    <a href="https://wa.me/5511999999999" class="float-whats" target="_blank"><i class="fa-brands fa-whatsapp"></i></a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASxticHF-jnuOj2xcHm0Jc3P4U0ZOzF10",
            authDomain: "doce-moldy.firebaseapp.com",
            projectId: "doce-moldy",
            storageBucket: "doce-moldy.firebasestorage.app",
            messagingSenderId: "965940506290",
            appId: "1:965940506290:web:0067cfc07ad49399eb23ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let carrinho = JSON.parse(localStorage.getItem('carrinho_doce_moldy')) || [];
        
        const indiceTroca = localStorage.getItem('indice_troca');
        const isTrocaMode = indiceTroca !== null;

        if(isTrocaMode) {
            document.getElementById('troca-bar').style.display = 'block';
            document.body.style.paddingTop = '140px'; 
        }

        window.showToast = (msg) => {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerHTML = `‚úÖ ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        window.cancelarTroca = () => { localStorage.removeItem('indice_troca'); window.location.reload(); }

        window.realizarTroca = (nome, preco, imagem) => {
            const index = parseInt(localStorage.getItem('indice_troca'));
            if(!isNaN(index) && carrinho[index]) {
                carrinho[index] = { nome, preco, imagem };
                salvarDadosUsuario();
                localStorage.removeItem('indice_troca');
                window.showToast(`Trocado por "${nome}"!`);
                setTimeout(() => window.location.href = 'carrinho.html', 1500);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const nomeCurto = user.displayName ? user.displayName.split(' ')[0] : 'Conta';
                document.getElementById('user-label').innerHTML = `Ol√°, ${nomeCurto}`;
                document.getElementById('user-link').href = "perfil.html";
                
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.cart) carrinho = data.cart;
                    atualizarMiniCart();
                }
            } else {
                document.getElementById('user-label').innerHTML = "Entrar /<br>Cadastrar";
                document.getElementById('user-link').href = "conta.html";
            }
        });

        async function salvarDadosUsuario() {
            localStorage.setItem('carrinho_doce_moldy', JSON.stringify(carrinho));
            if(currentUser) {
                await setDoc(doc(db, "users", currentUser.uid), { cart: carrinho, email: currentUser.email }, { merge: true });
            }
        }

        window.atualizarMiniCart = () => {
            if(isTrocaMode) return;
            const badge = document.getElementById('cart-count');
            const dropdown = document.getElementById('mini-cart-content');
            
            badge.innerText = carrinho.length;
            if(carrinho.length > 0) badge.classList.add('visible');
            else badge.classList.remove('visible');

            if(carrinho.length === 0) {
                dropdown.innerHTML = '<p style="text-align:center; padding:10px; color:#999">Vazio</p>'; return;
            }

            let html = ''; let total = 0;
            carrinho.slice().reverse().slice(0, 3).forEach((item, idx) => {
                const realIdx = carrinho.length - 1 - idx;
                let p = parseFloat(item.preco.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                total += p;
                html += `
                    <div class="mini-item">
                        <img src="${item.imagem}" class="mini-img">
                        <div class="mini-info">
                            <div style="font-weight:700; overflow:hidden; text-overflow:ellipsis; max-width:180px; white-space:nowrap;">${item.nome}</div>
                            <div style="color:var(--primary)">${item.preco}</div>
                        </div>
                        <button class="mini-del" onclick="removerDoMini(${realIdx})"><i class="fa-solid fa-trash"></i></button>
                    </div>`;
            });
            html += `<a href="carrinho.html" style="display:block; text-align:center; background:#10B981; color:white; padding:10px; border-radius:8px; font-weight:700; text-decoration:none;">Ver Carrinho</a>`;
            dropdown.innerHTML = html;
        };

        window.removerDoMini = (idx) => {
            carrinho.splice(idx, 1);
            salvarDadosUsuario();
            atualizarMiniCart();
        };

        window.adicionarAoCarrinho = (btn, nome, preco, imagem) => {
            carrinho.push({ nome, preco, imagem });
            salvarDadosUsuario();
            atualizarMiniCart();
            
            const card = btn.closest('.product-card');
            const imgEl = card.querySelector('.p-img-box img');
            const cartIcon = document.getElementById('cart-icon');
            if (imgEl && cartIcon) {
                const fly = imgEl.cloneNode();
                fly.classList.add('fly-img');
                const rect = imgEl.getBoundingClientRect();
                fly.style.top = rect.top + 'px'; fly.style.left = rect.left + 'px';
                fly.style.width = rect.width + 'px'; fly.style.height = rect.height + 'px';
                document.body.appendChild(fly);
                const end = cartIcon.getBoundingClientRect();
                setTimeout(() => {
                    fly.style.top = end.top + 'px'; fly.style.left = end.left + 'px';
                    fly.style.width = '20px'; fly.style.height = '20px'; fly.style.opacity = '0';
                }, 50);
                setTimeout(() => { fly.remove(); window.showToast("Adicionado!"); }, 800);
            } else {
                window.showToast("Adicionado!");
            }
        }

        function codificarCaminho(caminho) {
            if (!caminho) return '';
            return caminho.split('/').map(p => encodeURIComponent(p)).join('/');
        }

        async function carregar() {
            window.atualizarMiniCart();
            const q = query(collection(db, "produtos"), orderBy("date", "desc"));
            const sn = await getDocs(q);
            
            ['sec-carimbos', 'sec-doces', 'sec-modeladores', 'sec-outros'].forEach(id => document.getElementById(id).innerHTML="");
            
            if(sn.empty) return;

            sn.forEach(doc => {
                const i = doc.data();
                let target = 'sec-outros';
                if(i.category === 'Carimbos de Biscoito') target = 'sec-carimbos';
                else if(i.category === 'Carimbinhos doces') target = 'sec-doces';
                else if(i.category === 'modeladores') target = 'sec-modeladores';
                
                const container = document.getElementById(target);
                if(container) {
                    let imgs = Array.isArray(i.images) ? i.images : [i.img];
                    const fotosSeguras = imgs.map(url => {
                        let safe = url || '';
                        if(safe.startsWith('fotos/')) safe = safe.replace('fotos/', 'Fotos/');
                        return codificarCaminho(safe);
                    });
                    const imgCapa = fotosSeguras[0] || 'https://placehold.co/300';

                    let botaoHtml = '';
                    if (isTrocaMode) {
                        botaoHtml = `<button class="btn-add" style="background:#F59E0B;" onclick="realizarTroca('${i.name}', '${i.price}', '${imgCapa}')"><i class="fa-solid fa-rotate"></i> Substituir</button>`;
                    } else {
                        botaoHtml = `<button class="btn-add" onclick="adicionarAoCarrinho(this, '${i.name}', '${i.price}', '${imgCapa}')"><i class="fa-solid fa-cart-plus"></i> Comprar</button>`;
                    }

                    container.innerHTML += `
                    <div class="product-card" onmouseenter="iniciarSlide(this)" onmouseleave="pararSlide(this)" data-photos='${JSON.stringify(fotosSeguras)}'>
                        <a href="produto.html?id=${doc.id}" class="p-img-box">
                            <img src="${imgCapa}" class="slide-img" onerror="this.src='https://placehold.co/300'">
                        </a>
                        <div class="p-info">
                            <div class="p-title">${i.name}</div>
                            <div class="p-price">${i.price}</div>
                            ${botaoHtml}
                        </div>
                    </div>`;
                }
            });
        }

        window.intervals = {};
        window.iniciarSlide = (card) => {
            const fotos = JSON.parse(card.getAttribute('data-photos'));
            if(fotos.length <= 1) return;
            const imgEl = card.querySelector('.slide-img');
            let idx = 0;
            window.intervals[card] = setInterval(() => {
                idx = (idx + 1) % fotos.length;
                imgEl.style.opacity = '0.5';
                setTimeout(() => { imgEl.src = fotos[idx]; imgEl.style.opacity = '1'; }, 200);
            }, 3000);
        };
        window.pararSlide = (card) => {
            clearInterval(window.intervals[card]);
            const fotos = JSON.parse(card.getAttribute('data-photos'));
            const imgEl = card.querySelector('.slide-img');
            imgEl.src = fotos[0]; imgEl.style.opacity = '1';
        };

        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>
</html>